<!-- app/templates/base.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>{% block title %}Due Draghi 5e 2024 SRD{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/htmx.org@2.0.3"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml"/>
</head>
<body style="min-height: 100vh; display: flex; flex-direction: column; background: var(--notion-bg); color: var(--notion-text);">
  <!-- Notion-style top bar -->
  <header class="notion-nav">
    <div class="notion-nav-container">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="/" class="btn">Home</a>
        {% if collection %}
          <span style="color: var(--notion-text-light);">/</span>
          <a href="/{{ collection }}{% if qs %}?{{ qs }}{% endif %}" class="btn">{{ collection }}</a>
          <span class="breadcrumb-separator">/</span>
          <div class="search-container">
            <input id="bc-search" name="q" placeholder="{{ doc_slug or doc_title or ('Cerca in ' ~ collection ~ '…') }}" class="field" style="width: 240px; font-size: 13px; padding: 6px 10px;"
                   hx-get="/quicksearch/{{ collection }}"
                   hx-target="#bc-results"
                   hx-trigger="keyup changed delay:200ms"
                   autocomplete="off" aria-controls="bc-results" aria-expanded="false" />
            <div id="bc-results" class="search-results hidden" 
                 role="listbox" aria-label="Risultati ricerca rapida"></div>
          </div>
        {% endif %}
        {% if doc_title and not collection %}
          <span style="color: var(--notion-text-light);">/</span>
          <span style="color: var(--notion-text); font-weight: 500; max-width: 40vw;" class="truncate" title="{{ doc_title }}">{{ doc_title }}</span>
        {% elif doc_id and not collection %}
          <span style="color: var(--notion-text-light);">/</span>
          <span class="mono tag" title="{{ doc_id }}">{{ doc_id }}</span>
        {% endif %}
      </nav>
    </div>
  </header>

  <!-- Notion-style content area -->
  <main style="flex: 1; background: var(--notion-bg);">
    <div id="page-root" hx-history-elt class="container" style="max-width: 1024px; padding-top: 2rem; padding-bottom: 2rem;">
      {% block content %}{% endblock %}
      <div id="page-loading" class="page-overlay" aria-hidden="true">
        <div class="page-overlay-inner">
          <span class="spinner"></span>
          <span style="font-size: var(--font-size-sm); color: var(--notion-text-light);">Caricamento…</span>
        </div>
      </div>
    </div>
  </main>

  {% block scripts %}{% endblock %}
  <script>
    // Language switching removed - Italian only
    // Global helpers available to all pages
    // Removed textarea-specific clipboard helpers (no per-field editor)
    function toggleFull(btn){
      const wrap = btn.closest('.relative'); if(!wrap) return;
      const ta = wrap.querySelector('textarea');
      const expanded = !wrap.classList.contains('fixed');
      // Enter/exit full-screen overlay without breaking layout
      wrap.classList.toggle('fixed', expanded);
      wrap.classList.toggle('inset-0', expanded);
      wrap.classList.toggle('md:inset-6', expanded);
      wrap.classList.toggle('z-50', expanded);
      wrap.classList.toggle('bg-white', expanded);
      wrap.classList.toggle('border', expanded);
      // removed rounded corners for minimal look
      wrap.classList.toggle('p-4', expanded);
      wrap.classList.toggle('max-w-screen-xl', expanded);
      wrap.classList.toggle('mx-auto', expanded);
      wrap.classList.toggle('overflow-auto', expanded);
      if(ta){ ta.classList.toggle('min-h-[80vh]', expanded); autoGrow(ta); }
      // Lock/unlock page scroll while expanded
      try { document.documentElement.style.overflow = expanded ? 'hidden' : ''; } catch(e){}
      btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      btn.textContent = expanded ? 'Riduci' : 'Espandi';
    }
    function flash(anchorEl, msg){
      const n = document.createElement('span');
      n.className = 'ml-2 inline-flex items-center px-2 py-1 text-xs';
      n.style.cssText = 'background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; border-radius: var(--notion-radius); font-size: 12px;';
      n.textContent = msg;
      anchorEl.insertAdjacentElement('afterend', n);
      setTimeout(()=>n.remove(), 1200);
    }

    // Removed old per-field save toasts

    // Init on load
    document.addEventListener('DOMContentLoaded', function(){
      // Update header height CSS var
      try {
        const hdr = document.querySelector('header');
        const setH = ()=>{ if(hdr){ document.documentElement.style.setProperty('--site-header-h', hdr.offsetHeight + 'px'); } };
        setH();
        window.addEventListener('resize', setH);
      } catch(e) {}
    });

    // Markdown rendering for elements with [data-markdown]
    function initMarkdown(){
      const hasMarked = typeof window.marked !== 'undefined';
      if (hasMarked && window.marked.setOptions){
        try { window.marked.setOptions({ headerIds: true, mangle: false }); } catch(e) {}
      }
      document.querySelectorAll('[data-markdown]').forEach(el=>{
        if (el.getAttribute('data-ssr') === 'true') return; // skip SSR-rendered blocks
        let raw = '';
        const srcId = el.getAttribute('data-md-src-id');
        if (srcId){
          const src = document.getElementById(srcId);
          if (src) raw = src.textContent || '';
        }
        if (!raw){ raw = el.textContent || ''; }
        el.dataset.raw = raw;
        if(hasMarked){ el.innerHTML = window.marked.parse(raw); }
        else { 
          // Basic markdown fallback - handle headings at least
          let processed = raw
            .replace(/^### (.*$)/mg, '<h3>$1</h3>')
            .replace(/^## (.*$)/mg, '<h2>$1</h2>')
            .replace(/^# (.*$)/mg, '<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br/>');
          el.innerHTML = '<p>' + processed + '</p>';
        }
        el.querySelectorAll('table').forEach(tbl=>{
          const wrap = document.createElement('div');
          wrap.className = 'overflow-x-auto';
          tbl.parentNode.insertBefore(wrap, tbl);
          wrap.appendChild(tbl);
        });
      });
      try { document.dispatchEvent(new CustomEvent('markdown:rendered')); } catch(e) {}
    }
    document.addEventListener('DOMContentLoaded', initMarkdown);
    document.body.addEventListener('htmx:afterSwap', initMarkdown);

    // Copy raw Markdown from nearest [data-markdown]
    function copyMarkdown(btn){
      const section = btn.closest('[data-md-section]') || btn.closest('article') || document;
      let md = section.querySelector('[data-markdown]');
      if (!md) md = section.querySelector('[data-ssr="true"]');
      const raw = (md && (md.dataset.raw || md.getAttribute('data-raw') || md.textContent)) || '';
      if(!raw) return;
      
      // Try modern clipboard API first (works in HTTPS/localhost)
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(raw).then(()=>flash(btn, 'Copiato')).catch(()=>{
          fallbackCopy(raw, btn);
        });
      } else {
        // Fallback for HTTP deployments
        fallbackCopy(raw, btn);
      }
    }
    
    // Fallback copy method using temporary textarea
    function fallbackCopy(text, btn) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.left = '-999999px';
      textarea.style.top = '-999999px';
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          flash(btn, 'Copiato');
        } else {
          flash(btn, 'Errore copia');
        }
      } catch (err) {
        flash(btn, 'Errore copia');
      }
      document.body.removeChild(textarea);
    }

    // Quicksearch dropdown behavior
    document.addEventListener('htmx:afterOnLoad', (e)=>{
      if(e.detail && e.detail.elt && e.detail.elt.id === 'bc-results'){
        e.detail.elt.classList.remove('hidden');
        const input = document.getElementById('bc-search');
        if(input) input.setAttribute('aria-expanded','true');
      }
    });
    document.addEventListener('click', (e)=>{
      const res = document.getElementById('bc-results');
      if(!res) return;
      const input = document.getElementById('bc-search');
      const within = res.contains(e.target) || (input && input.contains(e.target));
      if(!within){ res.classList.add('hidden'); if(input) input.setAttribute('aria-expanded','false'); }
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){
        const res=document.getElementById('bc-results'); if(res) res.classList.add('hidden');
        const input = document.getElementById('bc-search'); if(input) input.setAttribute('aria-expanded','false');
      }
      if(e.key==='Enter'){
        const input = document.getElementById('bc-search');
        if(input && document.activeElement === input){
          const first = document.querySelector('#bc-results a');
          if(first){ e.preventDefault(); window.location = first.getAttribute('href'); }
          else if(input.value){ window.location = '/{{ collection or '' }}?q=' + encodeURIComponent(input.value); }
        }
      }
      if(e.key==='ArrowDown'){
        const input = document.getElementById('bc-search');
        if(input && document.activeElement === input){
          const first = document.querySelector('#bc-results a');
          if(first){ e.preventDefault(); try{ first.focus(); }catch(_){} }
        }
      }
    });
    (function(){
      const btn = document.getElementById('menu-toggle');
      const nav = document.getElementById('nav-links');
      if(!btn || !nav) return;
      btn.addEventListener('click', ()=>{
        const hidden = nav.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', (!hidden).toString());
      });
      document.addEventListener('click', (e)=>{
        if(nav.classList.contains('hidden')) return;
        if(!nav.contains(e.target) && e.target !== btn){
          nav.classList.add('hidden');
          btn.setAttribute('aria-expanded','false');
        }
      });
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
          nav.classList.add('hidden');
          btn.setAttribute('aria-expanded','false');
        }
      });
    })();
  </script>
</body>
</html>
