{{define "title"}}Parser - Due Draghi 5e SRD{{end}}

{{define "content"}}
<div class="notion-page">
  <h1 class="notion-h1">Parser SRD</h1>
  
  <div style="margin-bottom: 2rem;">
    <p>Interfaccia per l'elaborazione e importazione dei file markdown SRD nel database.</p>
  </div>

  <form id="parser-form" hx-post="/run" hx-target="#parser-results" hx-swap="innerHTML">
    <div class="form-section" style="margin-bottom: 1.5rem;">
      <h2 class="notion-h2">Configurazione</h2>
      
      <div class="form-field">
        <label for="input_dir" class="form-label">Cartella Input:</label>
        <input type="text" id="input_dir" name="input_dir" value="{{.env.input_dir}}" class="field" required>
      </div>
      
      <div class="form-field">
        <label for="db_name" class="form-label">Database:</label>
        <input type="text" id="db_name" name="db_name" value="{{.env.db_name}}" class="field" required>
      </div>
      
      <div class="form-field">
        <label class="form-label">
          <input type="checkbox" id="dry_run" name="dry_run" {{if .env.dry_run}}checked{{end}}>
          Dry Run (solo simulazione)
        </label>
      </div>
    </div>

    <div class="form-section" style="margin-bottom: 1.5rem;">
      <h2 class="notion-h2">Collezioni da Processare</h2>
      
      <div style="margin-bottom: 1rem;">
        <button type="button" onclick="selectAll()" class="btn btn-secondary">Seleziona Tutto</button>
        <button type="button" onclick="selectNone()" class="btn btn-secondary">Deseleziona Tutto</button>
      </div>

      <div class="work-items-grid" style="display: grid; gap: 0.5rem; max-height: 400px; overflow-y: auto; border: 1px solid var(--notion-border); border-radius: 6px; padding: 1rem;">
        {{range $item := .work_items}}
        <label class="work-item" style="display: flex; align-items: center; padding: 0.5rem; border: 1px solid transparent; border-radius: 4px; cursor: pointer;" onclick="this.style.backgroundColor = this.firstElementChild.checked ? 'transparent' : 'var(--notion-bg-selected)'">
          <input type="checkbox" name="selected" value="{{$item.idx}}" style="margin-right: 0.5rem;">
          <span class="collection-badge" style="background: var(--notion-bg-selected); padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 500; margin-right: 0.5rem;">{{$item.collection}}</span>
          <span style="font-size: 13px; color: var(--notion-text-light);">{{$item.filename}}</span>
        </label>
        {{end}}
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        <span id="submit-text">Avvia Parser</span>
        <span id="submit-loading" class="spinner" style="display: none;"></span>
      </button>
    </div>
  </form>

  <div id="parser-results" style="margin-top: 2rem;">
    {{if .messages}}
    <div class="results-section">
      <h2 class="notion-h2">Risultati</h2>
      <div class="messages" style="background: var(--notion-bg-code); border-radius: 6px; padding: 1rem; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; line-height: 1.5;">
        {{range .messages}}
        <div style="margin-bottom: 0.25rem;">{{.}}</div>
        {{end}}
      </div>
    </div>
    {{end}}
  </div>
</div>

<style>
.form-section {
  background: var(--notion-bg);
  border: 1px solid var(--notion-border);
  border-radius: 8px;
  padding: 1.5rem;
}

.form-field {
  margin-bottom: 1rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: var(--notion-text);
}

.field {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--notion-border);
  border-radius: 4px;
  background: var(--notion-bg);
  color: var(--notion-text);
}

.work-item:hover {
  background: var(--notion-bg-hover) !important;
}

.form-actions {
  display: flex;
  gap: 1rem;
}

.results-section {
  border: 1px solid var(--notion-border);
  border-radius: 8px;
  padding: 1.5rem;
  background: var(--notion-bg);
}

.messages div {
  color: var(--notion-text-light);
}
</style>

<script>
function selectAll() {
  document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = true);
}

function selectNone() {
  document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = false);
}

// Handle form submission loading state
document.getElementById('parser-form').addEventListener('htmx:beforeRequest', function() {
  document.getElementById('submit-text').style.display = 'none';
  document.getElementById('submit-loading').style.display = 'inline-block';
});

document.getElementById('parser-form').addEventListener('htmx:afterRequest', function() {
  document.getElementById('submit-text').style.display = 'inline-block';
  document.getElementById('submit-loading').style.display = 'none';
});
</script>
{{end}}