{% extends "base.html" %}
{% block title %}SRD Parser{% endblock %}

{% block content %}
<div id="page-root" class="space-y-4 sm:space-y-6 px-4 sm:px-6 mx-auto max-w-6xl">
  <!-- Header -->
  <div class="text-center">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">SRD Parser</h1>
    <p class="text-sm sm:text-base text-gray-600">Seleziona i documenti da analizzare e processare</p>
  </div>

  <!-- Main Form -->
  <form id="parser-form" method="post" action="/run" 
        hx-post="/run" hx-target="#page-root" hx-swap="outerHTML" hx-indicator="#run-spinner">
    
    <!-- Hidden fields for filters (all enabled) -->
    <input type="hidden" name="flt_it" value="on" />
    <input type="hidden" name="flt_en" value="on" />
    <input type="hidden" name="flt_docs" value="on" />
    
    <!-- Settings Card -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-4">Impostazioni</h2>
      
      <div class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="input_dir" class="block text-sm font-medium text-gray-700 mb-1">Cartella Input</label>
            <input type="text" id="input_dir" name="input_dir" value="{{ env.input_dir }}" class="field" placeholder="/data" />
            <p class="text-xs text-gray-500 mt-1">Percorso della cartella contenente i file SRD</p>
          </div>
          
          <div>
            <label for="mongo_instance" class="block text-sm font-medium text-gray-700 mb-1">MongoDB Host</label>
            <input type="text" id="mongo_instance" name="mongo_instance" value="{{ env.mongo_instance }}" class="field" placeholder="localhost:27017"
                   hx-post="/test-conn" hx-trigger="change, keyup changed delay:500ms"
                   hx-target="#conn-result" hx-swap="outerHTML"
                   hx-include="[name='mongo_instance'], [name='db_name']" hx-indicator="#conn-spinner" />
          </div>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="db_name" class="block text-sm font-medium text-gray-700 mb-1">Database Name</label>
            <input type="text" id="db_name" name="db_name" value="{{ env.db_name }}" class="field" placeholder="dnd"
                   hx-post="/test-conn" hx-trigger="change, keyup changed delay:500ms"
                   hx-target="#conn-result" hx-swap="outerHTML"
                   hx-include="[name='mongo_instance'], [name='db_name']" hx-indicator="#conn-spinner" />
          </div>
          
          <div class="flex items-center pt-6">
            <label class="flex items-center space-x-2">
              <input type="checkbox" name="dry_run" {% if env.dry_run %}checked{% endif %} 
                     class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
              <span class="text-sm font-medium text-gray-700">Dry Run (solo test, non scrivere)</span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Connection Test -->
      <div class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-3 pt-4 border-t">
        <button type="button" class="btn btn-secondary w-full sm:w-auto"
                hx-post="/test-conn" hx-target="#conn-result" hx-swap="outerHTML"
                hx-include="[name='mongo_instance'], [name='db_name']" hx-indicator="#conn-spinner">
          Test Connessione
        </button>
        <span id="conn-spinner" class="hidden">
          <span class="spinner"></span>
        </span>
        <div id="conn-result" class="text-sm"></div>
      </div>
      
      {% if not env.dry_run %}
      <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-amber-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-amber-800 text-sm font-medium">Modalit√† scrittura attiva - I dati saranno scritti su MongoDB</span>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Documents Available -->
    <div class="card">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 space-y-3 sm:space-y-0">
        <h2 class="text-lg sm:text-xl font-semibold">Documenti Disponibili</h2>
        <div class="flex items-center space-x-2">
          <input id="search" name="q" value="{{ q or '' }}" type="search" class="field w-full sm:w-64" placeholder="Cerca documenti..."
                 hx-post="/collections" hx-trigger="keyup changed delay:300ms" hx-include="#parser-form" 
                 hx-target="#collections-container" hx-swap="outerHTML" />
        </div>
      </div>
      
      <div id="collections-container">
        {% include "_collections.html" %}
      </div>
    </div>

    <!-- Floating Action Bar -->
    <div class="fixed bottom-4 left-4 right-4 sm:bottom-6 sm:left-auto sm:right-6 sm:max-w-sm z-50">
      <div class="bg-white/95 backdrop-blur-sm rounded-lg shadow-xl border border-gray-200 p-3 sm:p-4">
        
        <!-- Parse Result Feedback -->
        {% if messages and messages|length %}
        <div id="parse-result" class="mb-4 p-3 rounded-lg">
          {% set total_processed = messages|length %}
          {% set error_messages = [] %}
          {% set success_messages = [] %}
          {% for message in messages %}
            {% set msg_lower = message|lower %}
            {% if 'errore' in msg_lower or 'fallita' in msg_lower %}
              {% set _ = error_messages.append(message) %}
            {% elif 'estratti' in msg_lower or 'completato' in msg_lower %}
              {% set _ = success_messages.append(message) %}
            {% endif %}
          {% endfor %}
          {% set has_errors = error_messages|length > 0 %}
          {% set success_count = success_messages|length %}
          
          {% if has_errors %}
            <div class="bg-red-50 border border-red-200">
              <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm font-medium text-red-800">Parsing completato con errori</span>
              </div>
              <p class="text-xs text-red-700">Controlla i dettagli nel log sottostante</p>
            </div>
          {% else %}
            <div class="bg-green-50 border border-green-200">
              <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm font-medium text-green-800">Parsing completato con successo</span>
              </div>
              <p class="text-xs text-green-700">{{ success_count }} documenti processati correttamente</p>
            </div>
          {% endif %}
          
          <button type="button" onclick="document.getElementById('parse-result').style.display='none'" 
                  class="mt-2 text-xs text-gray-500 hover:text-gray-700 underline">
            Nascondi
          </button>
        </div>
        {% endif %}
        
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 space-y-2 sm:space-y-0">
          <div class="flex items-center justify-center sm:justify-start space-x-3">
            <span class="text-sm text-gray-600">
              <strong id="selected-count">0</strong> selezionati
            </span>
            <span id="mode-badge" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              Scrittura
            </span>
          </div>
        </div>
        
        <div class="flex flex-col space-y-2">
          <span id="run-spinner" class="hidden flex items-center justify-center space-x-2 text-sm text-gray-600">
            <span class="spinner"></span>
            <span>Elaborazione...</span>
          </span>
          <button id="run-btn" type="submit" class="btn btn-primary w-full text-sm sm:text-base" disabled>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Avvia Parsing
          </button>
        </div>
      </div>
    </div>
    
    <!-- Spacer to prevent content from being hidden behind floating bar -->
    <div class="h-28 sm:h-24"></div>
  </form>

  <!-- Results Log -->
  {% if messages and messages|length %}
  <div class="card">
    <h2 class="text-xl font-semibold mb-4">Risultati Elaborazione</h2>
    <div class="space-y-2 max-h-96 overflow-y-auto">
      {% for message in messages %}
      {% set msg_lower = message|lower %}
      {% set is_error = 'errore' in msg_lower or 'fallita' in msg_lower %}
      {% set is_success = ('estratti' in msg_lower or 'completato' in msg_lower) and not is_error %}
      
      <div class="p-3 rounded border-l-4 {% if is_error %}border-red-500 bg-red-50{% elif is_success %}border-green-500 bg-green-50{% else %}border-blue-500 bg-blue-50{% endif %}">
        <p class="text-sm font-mono {% if is_error %}text-red-800{% elif is_success %}text-green-800{% else %}text-blue-800{% endif %}">{{ message }}</p>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  'use strict';
  
  function getSelectedCount() {
    return document.querySelectorAll('#collections-container input[name="selected"]:checked').length;
  }
  
  function updateSelectedCount() {
    const count = getSelectedCount();
    document.getElementById('selected-count').textContent = count;
    
    const runBtn = document.getElementById('run-btn');
    if (count > 0) {
      runBtn.disabled = false;
      runBtn.classList.remove('opacity-50');
    } else {
      runBtn.disabled = true;
      runBtn.classList.add('opacity-50');
    }
  }
  
  function updateModeBadge() {
    const isDryRun = document.querySelector('input[name="dry_run"]').checked;
    const badge = document.getElementById('mode-badge');
    
    if (isDryRun) {
      badge.textContent = 'Dry Run';
      badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
    } else {
      badge.textContent = 'Scrittura';
      badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800';
    }
  }
  
  function bindEvents() {
    document.querySelectorAll('#collections-container input[name="selected"]').forEach(checkbox => {
      checkbox.addEventListener('change', updateSelectedCount);
    });
  }
  
  // Toast notification system
  function showToast(message, type = 'info', duration = 4000) {
    const toast = document.createElement('div');
    const isMobile = window.innerWidth < 640;
    
    if (isMobile) {
      toast.className = `fixed top-4 left-4 right-4 z-[60] p-3 rounded-lg shadow-lg border transition-all duration-300 transform -translate-y-full`;
    } else {
      toast.className = `fixed top-6 right-6 z-[60] p-4 rounded-lg shadow-lg border max-w-sm transition-all duration-300 transform translate-x-full`;
    }
    
    const colors = {
      success: 'bg-green-50 border-green-200 text-green-800',
      error: 'bg-red-50 border-red-200 text-red-800',
      info: 'bg-blue-50 border-blue-200 text-blue-800',
      warning: 'bg-amber-50 border-amber-200 text-amber-800'
    };
    
    const icons = {
      success: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`,
      error: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`,
      info: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>`,
      warning: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`
    };
    
    toast.classList.add(colors[type] || colors.info);
    toast.innerHTML = `
      <div class="flex items-start space-x-3">
        <div class="flex-shrink-0">
          ${icons[type] || icons.info}
        </div>
        <div class="flex-1 text-sm font-medium">${message}</div>
        <button onclick="this.closest('.fixed').remove()" class="flex-shrink-0 text-gray-400 hover:text-gray-600 p-1 touch-manipulation">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
      if (isMobile) {
        toast.classList.remove('-translate-y-full');
      } else {
        toast.classList.remove('translate-x-full');
      }
    }, 100);
    
    // Auto remove
    setTimeout(() => {
      if (isMobile) {
        toast.classList.add('-translate-y-full');
      } else {
        toast.classList.add('translate-x-full');
      }
      setTimeout(() => {
        if (toast.parentNode) {
          toast.remove();
        }
      }, 300);
    }, duration);
  }
  
  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
    updateModeBadge();
    bindEvents();
    
    // Add event listener for dry run checkbox
    const dryRunCheckbox = document.querySelector('input[name="dry_run"]');
    if (dryRunCheckbox) {
      dryRunCheckbox.addEventListener('change', updateModeBadge);
    }
    
    // Form submission handling
    const form = document.getElementById('parser-form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const count = getSelectedCount();
        if (count === 0) {
          e.preventDefault();
          showToast('Seleziona almeno un documento da processare', 'warning');
          return;
        }
        
        const isDryRun = document.querySelector('input[name="dry_run"]').checked;
        if (!isDryRun) {
          const confirmed = confirm(`Sei sicuro di voler processare ${count} documento${count > 1 ? 'i' : ''}? I dati saranno scritti su MongoDB.`);
          if (!confirmed) {
            e.preventDefault();
            return;
          }
        }
        
        // Show start notification
        showToast(`Avvio parsing di ${count} documento${count > 1 ? 'i' : ''}...`, 'info', 3000);
      });
    }
    
    // Show completion notification if there are messages
    {% if messages and messages|length %}
    const hasErrors = {{ 'true' if has_errors else 'false' }};
    const successCount = {{ success_count }};
    
    if (hasErrors) {
      showToast('Parsing completato con alcuni errori. Controlla i risultati.', 'error', 5000);
    } else {
      showToast(`Parsing completato! ${successCount} documenti processati con successo.`, 'success', 5000);
    }
    {% endif %}
  });
  
  // HTMX events
  document.body.addEventListener('htmx:afterSwap', function(e) {
    if (e.detail.target.id === 'collections-container') {
      updateSelectedCount();
      bindEvents();
    }
  });
  
  // HTMX request events
  document.body.addEventListener('htmx:beforeRequest', function(e) {
    if (e.detail.elt && e.detail.elt.closest('form') && e.detail.elt.closest('form').id === 'parser-form') {
      const isFormSubmit = e.detail.elt.type === 'submit';
      if (isFormSubmit) {
        // This will be handled by form submit event
      }
    }
  });
  
  // Mobile-friendly keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT') return;
    
    // Only enable keyboard shortcuts on non-mobile devices
    if (window.innerWidth >= 640 && e.key === '/') {
      e.preventDefault();
      document.getElementById('search').focus();
    }
  });
  
  // Handle viewport changes for mobile orientation
  let resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      // Refresh layout calculations on orientation change
      if (window.innerWidth < 640) {
        document.body.classList.add('mobile-view');
      } else {
        document.body.classList.remove('mobile-view');
      }
    }, 250);
  });
  
  // Add mobile class on initial load
  if (window.innerWidth < 640) {
    document.body.classList.add('mobile-view');
  }
  
  // Prevent double-tap zoom on buttons
  document.addEventListener('touchend', function(e) {
    if (e.target.closest('.btn') || e.target.closest('button')) {
      e.preventDefault();
      e.target.click();
    }
  }, { passive: false });
})();
</script>
{% endblock %}