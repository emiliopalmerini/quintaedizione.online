<!-- app/templates/list.html -->
{% extends "base.html" %}
{% block title %}{{ collection }} • Lista{% endblock %}
{% block header_actions %}
  <a href="/" class="btn btn-ghost">Tutte le collezioni</a>
{% endblock %}
{% block content %}
  <section class="bg-white border p-2 mb-3">
    <form id="search-form"
      hx-get="/view/{{ collection }}"
      hx-target="#rows"
      hx-trigger="submit, keyup delay:300ms from:#q, change from:select, change from:input[type=checkbox], change from:input[type=number]"
      hx-push-url="true"
      class="flex flex-col gap-2"
    >
      <div class="flex items-center gap-2 flex-wrap">
        <input id="q" name="q" placeholder="Cerca…" value="{{ q or '' }}" class="field flex-1" />
        <select name="page_size" class="field w-28">
          {% for s in [10,20,50,100] %}
            <option value="{{ s }}" {% if page_size==s %}selected{% endif %}>{{ s }}/pagina</option>
          {% endfor %}
        </select>
        {# pulsante submit minimale #}
        <button class="btn" type="submit">Cerca</button>
      </div>

      <details class="p-2">
        <summary class="cursor-pointer text-sm text-neutral-700">Filtri</summary>
        <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-3 gap-2">
          {% if collection == 'incantesimi' %}
            <select name="level" class="field"><option value="">Livello (tutti)</option>{% for i in range(0,10) %}<option value="{{ i }}" {% if request and request.query_params.get('level')==i|string %}selected{% endif %}>{{ i }}</option>{% endfor %}</select>
            <select name="school" class="field">
              <option value="">Scuola (tutte)</option>
              {% for s in ['Abiurazione','Ammaliamento','Divinazione','Evocazione','Illusione','Invocazione','Necromanzia','Trasmutazione'] %}
                <option value="{{ s }}" {% if request and request.query_params.get('school')==s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
            <select name="ritual" class="field">
              <option value="">Rituale (tutti)</option>
              <option value="true" {% if request and request.query_params.get('ritual')=='true' %}selected{% endif %}>Sì</option>
              <option value="false" {% if request and request.query_params.get('ritual')=='false' %}selected{% endif %}>No</option>
            </select>
            <select name="classes" class="field"
                    hx-get="/api/filter-options/incantesimi/classi"
                    hx-trigger="load once"
                    hx-target="this"
                    hx-swap="innerHTML"
                    hx-include="[name='classes']">
              <option value="">Classe (tutte)</option>
              <option>Caricamento...</option>
            </select>
          {% elif collection == 'oggetti_magici' %}
            <select name="rarity" class="field">
              <option value="">Rarità (tutte)</option>
              {% for r in ['Comune','Non comune','Raro','Molto raro','Leggendario','Artefatto'] %}
                <option value="{{ r }}" {% if request and request.query_params.get('rarity')==r %}selected{% endif %}>{{ r }}</option>
              {% endfor %}
            </select>
            <select name="type" class="field"
                    hx-get="/api/filter-options/oggetti_magici/tipo"
                    hx-trigger="load once"
                    hx-target="this"
                    hx-swap="innerHTML"
                    hx-include="[name='type']">
              <option value="">Tipo (tutti)</option>
              <option>Caricamento...</option>
            </select>
            <select name="attunement" class="field">
              <option value="">Sintonizzazione (tutte)</option>
              <option value="true" {% if request and request.query_params.get('attunement')=='true' %}selected{% endif %}>Richiede</option>
              <option value="false" {% if request and request.query_params.get('attunement')=='false' %}selected{% endif %}>Non richiede</option>
            </select>
          {% elif collection == 'mostri' %}
            <select name="size" class="field">
              <option value="">Taglia (tutte)</option>
              {% for s in ['Minuscola','Piccola','Media','Grande','Enorme','Mastodontica'] %}
                <option value="{{ s }}" {% if request and request.query_params.get('size')==s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
            <select name="type" class="field"
                    hx-get="/api/filter-options/mostri/tipo"
                    hx-trigger="load once"
                    hx-target="this"
                    hx-swap="innerHTML"
                    hx-include="[name='type']">
              <option value="">Tipo (tutti)</option>
              <option>Caricamento...</option>
            </select>
            <select name="alignment" class="field"
                    hx-get="/api/filter-options/mostri/allineamento"
                    hx-trigger="load once"
                    hx-target="this"
                    hx-swap="innerHTML"
                    hx-include="[name='alignment']">
              <option value="">Allineamento (tutti)</option>
              <option>Caricamento...</option>
            </select>
            <select name="cr" class="field"
                    hx-get="/api/filter-options/mostri/gs"
                    hx-trigger="load once"
                    hx-target="this"
                    hx-swap="innerHTML"
                    hx-include="[name='cr']">
              <option value="">GS (tutti)</option>
              <option>Caricamento...</option>
            </select>
          {% elif collection == 'armi' %}
            <input name="category" class="field" placeholder="Categoria (es. Semplice/Mischia)" value="{{ request and request.query_params.get('category','') }}" />
            <input name="mastery" class="field" placeholder="Maestria (es. Rallenta/Topple)" value="{{ request and request.query_params.get('mastery','') }}" />
            <input name="property" class="field" placeholder="Proprietà (es. Leggera/Lanciata)" value="{{ request and request.query_params.get('property','') }}" />
          {% elif collection == 'armature' %}
            <select name="category" class="field">
              <option value="">Categoria (tutte)</option>
              {% for cat in ['Leggera','Media','Pesante','Scudo'] %}
                <option value="{{ cat }}" {% if request and request.query_params.get('category')==cat %}selected{% endif %}>{{ cat }}</option>
              {% endfor %}
            </select>
            <select name="stealth" class="field">
              <option value="">Furtività (tutte)</option>
              <option value="true" {% if request and request.query_params.get('stealth')=='true' %}selected{% endif %}>Svantaggio</option>
              <option value="false" {% if request and request.query_params.get('stealth')=='false' %}selected{% endif %}>No svantaggio</option>
            </select>
            <select name="ac_base" class="field">
              <option value="">CA Base (tutte)</option>
              {% for ac in range(11, 19) %}
                <option value="{{ ac }}" {% if request and request.query_params.get('ac_base')==ac|string %}selected{% endif %}>{{ ac }}</option>
              {% endfor %}
            </select>
            <select name="strength" class="field">
              <option value="">Forza richiesta (tutte)</option>
              <option value="null" {% if request and request.query_params.get('strength')=='null' %}selected{% endif %}>Nessuna</option>
              <option value="13" {% if request and request.query_params.get('strength')=='13' %}selected{% endif %}>13</option>
              <option value="15" {% if request and request.query_params.get('strength')=='15' %}selected{% endif %}>15</option>
            </select>
            <select name="cost_range" class="field">
              <option value="">Costo (tutti)</option>
              <option value="0-10" {% if request and request.query_params.get('cost_range')=='0-10' %}selected{% endif %}>0-10 MO</option>
              <option value="11-50" {% if request and request.query_params.get('cost_range')=='11-50' %}selected{% endif %}>11-50 MO</option>
              <option value="51-200" {% if request and request.query_params.get('cost_range')=='51-200' %}selected{% endif %}>51-200 MO</option>
              <option value="201-750" {% if request and request.query_params.get('cost_range')=='201-750' %}selected{% endif %}>201-750 MO</option>
              <option value="751+" {% if request and request.query_params.get('cost_range')=='751+' %}selected{% endif %}>751+ MO</option>
            </select>
            <select name="weight_range" class="field">
              <option value="">Peso (tutti)</option>
              <option value="0-10" {% if request and request.query_params.get('weight_range')=='0-10' %}selected{% endif %}>0-10 lb</option>
              <option value="11-25" {% if request and request.query_params.get('weight_range')=='11-25' %}selected{% endif %}>11-25 lb</option>
              <option value="26-45" {% if request and request.query_params.get('weight_range')=='26-45' %}selected{% endif %}>26-45 lb</option>
              <option value="46+" {% if request and request.query_params.get('weight_range')=='46+' %}selected{% endif %}>46+ lb</option>
            </select>
          {% elif collection == 'strumenti' %}
            <input name="ability" class="field" placeholder="Caratteristica (es. Intelligenza)" value="{{ request and request.query_params.get('ability','') }}" />
            <input name="category" class="field" placeholder="Categoria (es. strumenti, kit)" value="{{ request and request.query_params.get('category','') }}" />
            <input name="craft" class="field" placeholder="Può creare (es. Pozione)" value="{{ request and request.query_params.get('craft','') }}" />
          {% elif collection == 'servizi' %}
            <input name="category" class="field" placeholder="Categoria (es. servizio, equipaggiamento)" value="{{ request and request.query_params.get('category','') }}" />
            <input name="availability" class="field" placeholder="Disponibilità (es. città, villaggio)" value="{{ request and request.query_params.get('availability','') }}" />
          {% elif collection == 'equipaggiamento' %}
            <input name="weight" class="field" placeholder="Peso (testo)" value="{{ request and request.query_params.get('weight','') }}" />
          {% elif collection == 'backgrounds' %}
            <input name="skill_proficiencies" class="field" placeholder="Competenze abilità" value="{{ request and request.query_params.get('skill_proficiencies','') }}" />
            <input name="tool_proficiencies" class="field" placeholder="Competenze strumenti" value="{{ request and request.query_params.get('tool_proficiencies','') }}" />
            <input name="languages" class="field" placeholder="Linguaggi" value="{{ request and request.query_params.get('languages','') }}" />
          {% elif collection == 'specie' %}
            <select name="size" class="field">
              <option value="">Taglia (tutte)</option>
              {% for s in ['Piccola','Media','Grande'] %}
                <option value="{{ s }}" {% if request and request.query_params.get('size')==s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
            <input name="creature_type" class="field" placeholder="Tipo creatura (es. umanoide)" value="{{ request and request.query_params.get('creature_type','') }}" />
            <input name="movement_speed" class="field" placeholder="Velocità (es. 9)" value="{{ request and request.query_params.get('movement_speed','') }}" />
            <input name="ability_score_increase" class="field" placeholder="Aumento caratteristica" value="{{ request and request.query_params.get('ability_score_increase','') }}" />
          {% elif collection == 'talenti' %}
            <select name="prerequisite_type" class="field">
              <option value="">Prerequisiti (tutti)</option>
              <option value="ability" {% if request and request.query_params.get('prerequisite_type')=='ability' %}selected{% endif %}>Caratteristica</option>
              <option value="class" {% if request and request.query_params.get('prerequisite_type')=='class' %}selected{% endif %}>Classe</option>
              <option value="level" {% if request and request.query_params.get('prerequisite_type')=='level' %}selected{% endif %}>Livello</option>
              <option value="none" {% if request and request.query_params.get('prerequisite_type')=='none' %}selected{% endif %}>Nessuno</option>
            </select>
            <input name="ability_increase" class="field" placeholder="Aumenta caratteristica (es. Forza)" value="{{ request and request.query_params.get('ability_increase','') }}" />
            <select name="category" class="field">
              <option value="">Categoria (tutte)</option>
              <option value="combat" {% if request and request.query_params.get('category')=='combat' %}selected{% endif %}>Combattimento</option>
              <option value="magic" {% if request and request.query_params.get('category')=='magic' %}selected{% endif %}>Magia</option>
              <option value="skill" {% if request and request.query_params.get('category')=='skill' %}selected{% endif %}>Abilità</option>
              <option value="utility" {% if request and request.query_params.get('category')=='utility' %}selected{% endif %}>Utilità</option>
            </select>
          {% elif collection == 'classi' %}
            <select name="caratteristica_primaria" class="field">
              <option value="">Caratteristica primaria (tutte)</option>
              {% for car in ['Forza','Destrezza','Costituzione','Intelligenza','Saggezza','Carisma'] %}
                <option value="{{ car }}" {% if request and request.query_params.get('caratteristica_primaria')==car %}selected{% endif %}>{{ car }}</option>
              {% endfor %}
            </select>
            <select name="dado_vita" class="field">
              <option value="">Dado vita (tutti)</option>
              {% for dado in ['d6','d8','d10','d12'] %}
                <option value="{{ dado }}" {% if request and request.query_params.get('dado_vita')==dado %}selected{% endif %}>{{ dado }}</option>
              {% endfor %}
            </select>
            <select name="ha_incantesimi" class="field">
              <option value="">Incantatori (tutti)</option>
              <option value="true" {% if request and request.query_params.get('ha_incantesimi')=='true' %}selected{% endif %}>Incantatori</option>
              <option value="false" {% if request and request.query_params.get('ha_incantesimi')=='false' %}selected{% endif %}>Non incantatori</option>
            </select>
            <select name="caratteristica_incantatore" class="field">
              <option value="">Car. incantatore (tutte)</option>
              {% for car in ['Intelligenza','Saggezza','Carisma'] %}
                <option value="{{ car }}" {% if request and request.query_params.get('caratteristica_incantatore')==car %}selected{% endif %}>{{ car }}</option>
              {% endfor %}
            </select>
            <select name="preparazione" class="field">
              <option value="">Tipo preparazione (tutti)</option>
              <option value="prepared" {% if request and request.query_params.get('preparazione')=='prepared' %}selected{% endif %}>Preparati</option>
              <option value="known" {% if request and request.query_params.get('preparazione')=='known' %}selected{% endif %}>Conosciuti</option>
            </select>
            <input name="armi_competenze" class="field" placeholder="Competenza armi (es. guerra)" value="{{ request and request.query_params.get('armi_competenze','') }}" />
          {% elif collection == 'documenti' %}
            <input name="numero_di_pagina" class="field" placeholder="Numero pagina" value="{{ request and request.query_params.get('numero_di_pagina','') }}" />
            <select name="category" class="field">
              <option value="">Categoria (tutte)</option>
              <option value="rules" {% if request and request.query_params.get('category')=='rules' %}selected{% endif %}>Regole</option>
              <option value="equipment" {% if request and request.query_params.get('category')=='equipment' %}selected{% endif %}>Equipaggiamento</option>
              <option value="magic" {% if request and request.query_params.get('category')=='magic' %}selected{% endif %}>Magia</option>
              <option value="character" {% if request and request.query_params.get('category')=='character' %}selected{% endif %}>Creazione personaggio</option>
              <option value="combat" {% if request and request.query_params.get('category')=='combat' %}selected{% endif %}>Combattimento</option>
              <option value="spells" {% if request and request.query_params.get('category')=='spells' %}selected{% endif %}>Incantesimi</option>
            </select>
            <input name="content" class="field" placeholder="Contenuto documento" value="{{ request and request.query_params.get('content','') }}" />
          {% else %}
            <div class="text-xs text-neutral-600">Nessun filtro specifico per {{ collection }}.</div>
          {% endif %}
        </div>
      </details>
    </form>
  </section>

  <section class="bg-white border">
    <div id="rows"
         hx-get="/view/{{ collection }}?page={{ page or 1 }}"
         hx-trigger="load"
         hx-include="#search-form"
         hx-push-url="true">
      <div class="px-3 py-4 text-sm text-neutral-600 flex items-center gap-2">
        <span class="spinner"></span>
        <span>Caricamento risultati…</span>
      </div>
    </div>
  </section>
{% endblock %}
