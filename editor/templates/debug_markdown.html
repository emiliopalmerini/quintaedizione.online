<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Debug Markdown Rendering</title>
  <script src="https://unpkg.com/htmx.org@2.0.3"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .test-section {
      border: 2px solid #ccc;
      margin: 20px 0;
      padding: 20px;
      background: #f9f9f9;
    }
    .test-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .markdown-content {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      background: white;
    }
    .raw-content {
      background: #f5f5f5;
      border: 1px solid #ccc;
      padding: 10px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div style="max-width: 1000px; margin: 0 auto; padding: 20px;">
    <h1>Debug Markdown Rendering</h1>
    
    <!-- Test 1: Check if marked.js is available -->
    <div class="test-section">
      <div class="test-title">Test 1: Marked.js Availability</div>
      <div id="marked-status"></div>
    </div>
    
    <!-- Test 2: Raw markdown content -->
    <div class="test-section">
      <div class="test-title">Test 2: Raw Markdown Content</div>
      <div class="raw-content" id="raw-content">## Ascia a Due Mani

Questa è una **descrizione** in *markdown*.

### Sottotitolo
- Lista item 1
- Lista item 2</div>
    </div>
    
    <!-- Test 3: Server-side rendering simulation -->
    <div class="test-section">
      <div class="test-title">Test 3: Client-side Rendering (marked.js)</div>
      <div class="markdown-content" id="marked-rendered"></div>
    </div>
    
    <!-- Test 4: Fallback rendering -->
    <div class="test-section">
      <div class="test-title">Test 4: Fallback Rendering (no marked.js)</div>
      <div class="markdown-content" id="fallback-rendered"></div>
    </div>
    
    <!-- Test 5: Current system behavior -->
    <div class="test-section">
      <div class="test-title">Test 5: Current System Behavior</div>
      <div class="markdown-content" data-markdown id="system-test">## Ascia a Due Mani

Questa è una **descrizione** in *markdown*.

### Sottotitolo
- Lista item 1
- Lista item 2</div>
    </div>
    
    <!-- Test 6: Inspect elements -->
    <div class="test-section">
      <div class="test-title">Test 6: Element Inspection</div>
      <div id="element-inspection"></div>
    </div>
  </div>

  <script>
    // Test 1: Check marked.js availability
    document.getElementById('marked-status').innerHTML = 
      typeof window.marked !== 'undefined' ? 
      '<span style="color: green;">✓ marked.js is available</span>' :
      '<span style="color: red;">✗ marked.js is NOT available</span>';
    
    // Get raw content
    const rawContent = document.getElementById('raw-content').textContent;
    
    // Test 3: marked.js rendering
    if (typeof window.marked !== 'undefined') {
      try {
        const markedResult = window.marked.parse(rawContent);
        document.getElementById('marked-rendered').innerHTML = markedResult;
      } catch (e) {
        document.getElementById('marked-rendered').innerHTML = '<span style="color: red;">Error: ' + e.message + '</span>';
      }
    } else {
      document.getElementById('marked-rendered').innerHTML = '<span style="color: red;">marked.js not available</span>';
    }
    
    // Test 4: Fallback rendering (new version)
    let processed = rawContent
      .replace(/^### (.*$)/mg, '<h3>$1</h3>')
      .replace(/^## (.*$)/mg, '<h2>$1</h2>')
      .replace(/^# (.*$)/mg, '<h1>$1</h1>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/\n\n/g, '</p><p>')
      .replace(/\n/g, '<br/>');
    document.getElementById('fallback-rendered').innerHTML = '<p>' + processed + '</p>';
    
    // Test 6: Element inspection
    setTimeout(() => {
      const systemTestEl = document.getElementById('system-test');
      const inspection = document.getElementById('element-inspection');
      
      inspection.innerHTML = `
        <strong>Element tag:</strong> ${systemTestEl.tagName}<br/>
        <strong>Element classes:</strong> ${systemTestEl.className}<br/>
        <strong>Data attributes:</strong> ${JSON.stringify(systemTestEl.dataset)}<br/>
        <strong>Computed background:</strong> ${getComputedStyle(systemTestEl).backgroundColor}<br/>
        <strong>Children count:</strong> ${systemTestEl.children.length}<br/>
        <strong>First child tag:</strong> ${systemTestEl.children.length > 0 ? systemTestEl.children[0].tagName : 'None'}<br/>
        <strong>Raw innerHTML:</strong><br/>
        <pre style="background: #f0f0f0; padding: 10px; margin-top: 5px;">${systemTestEl.innerHTML.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
      `;
    }, 1000);
    
    // Copy the markdown init function from base.html
    function initMarkdown(){
      console.log('initMarkdown called');
      const hasMarked = typeof window.marked !== 'undefined';
      console.log('hasMarked:', hasMarked);
      
      if (hasMarked && window.marked.setOptions){
        try { 
          window.marked.setOptions({ headerIds: true, mangle: false }); 
          console.log('marked.setOptions configured');
        } catch(e) {
          console.error('marked.setOptions error:', e);
        }
      }
      
      document.querySelectorAll('[data-markdown]').forEach(el=>{
        console.log('Processing element:', el);
        if (el.getAttribute('data-ssr') === 'true') {
          console.log('Skipping SSR element');
          return;
        }
        
        let raw = '';
        const srcId = el.getAttribute('data-md-src-id');
        if (srcId){
          const src = document.getElementById(srcId);
          if (src) raw = src.textContent || '';
        }
        if (!raw){ raw = el.textContent || ''; }
        console.log('Raw content:', raw);
        
        el.dataset.raw = raw;
        if(hasMarked){ 
          console.log('Using marked.js');
          el.innerHTML = window.marked.parse(raw); 
        }
        else { 
          console.log('Using fallback');
          // Basic markdown fallback - handle headings at least
          let processed = raw
            .replace(/^### (.*$)/mg, '<h3>$1</h3>')
            .replace(/^## (.*$)/mg, '<h2>$1</h2>')
            .replace(/^# (.*$)/mg, '<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br/>');
          el.innerHTML = '<p>' + processed + '</p>';
        }
        console.log('Final innerHTML:', el.innerHTML);
      });
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', initMarkdown);
  </script>
</body>
</html>