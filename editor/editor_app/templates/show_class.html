<!-- app/templates/show_class.html (updated for Italian fields) -->
{% extends "base.html" %}
{% block title %}{{ doc_title or doc_id }} ‚Ä¢ {{ collection }}{% endblock %}

{% block header_actions %}
  <nav class="flex items-center gap-2" aria-label="Azioni documento">
    <a href="/list/{{ collection }}{% if qs %}?{{ qs }}{% endif %}" class="btn btn-ghost">‚Üê Lista</a>
    <form method="get" action="/show/{{ collection }}/{{ prev_id }}" class="inline" aria-label="Documento precedente">
      {% if request %}
        {% for key, val in request.query_params.items() %}
          <input type="hidden" name="{{ key }}" value="{{ val }}">
        {% endfor %}
      {% endif %}
      <button type="submit" class="btn btn-ghost" {% if not prev_id %}disabled aria-disabled="true" tabindex="-1"{% endif %}>‚Äπ Precedente</button>
    </form>
    <form method="get" action="/show/{{ collection }}/{{ next_id }}" class="inline" aria-label="Documento successivo">
      {% if request %}
        {% for key, val in request.query_params.items() %}
          <input type="hidden" name="{{ key }}" value="{{ val }}">
        {% endfor %}
      {% endif %}
      <button type="submit" class="btn btn-ghost" {% if not next_id %}disabled aria-disabled="true" tabindex="-1"{% endif %}>Successivo ‚Ä∫</button>
    </form>
    
  </nav>
{% endblock %}
{% block scripts %}
  {{ super() }}
  <style>
    .anchor-btn { visibility: hidden; margin-left: .25rem; font-size: .85em; color: #6b7280; }
    h2:hover .anchor-btn, h3:hover .anchor-btn, h4:hover .anchor-btn { visibility: visible; }
    .section-toggle { margin-left: .25rem; font-size: .85em; color: #6b7280; }
  </style>
  <script>
    (function(){
      const docId = {{ doc_id | tojson }};
      function slugify(text){
        return (text || '').toString().toLowerCase()
          .replace(/\s+/g,'-')
          .replace(/[^\w\-√†√®√©√¨√≤√π√ß√±]/g,'')
          .replace(/\-+/g,'-')
          .replace(/^\-+|\-+$/g,'');
      }
      function ensureIds(container){
        container.querySelectorAll('h2, h3, h4').forEach(h=>{ if(!h.id){ h.id = slugify(h.textContent || 'sezione'); } });
      }
      
      function addAnchors(container){
        container.querySelectorAll('h2, h3, h4').forEach(h=>{
          const id = h.id; if(!id) return;
          const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'anchor-btn'; btn.textContent = 'üîó'; btn.title = 'Copia link sezione';
          btn.addEventListener('click', ()=>{ const url = window.location.origin + window.location.pathname + '#' + id; navigator.clipboard.writeText(url).then(()=>{ try { flash(btn,'Copiato'); } catch(e){} }); });
          h.appendChild(btn);
        });
      }
      function makeCollapsible(container){
        const hs = Array.from(container.querySelectorAll('h3'));
        hs.forEach((h, idx)=>{
          const nextH = hs[idx+1] || null; const wrapper = document.createElement('div'); wrapper.className = 'section-content';
          let n = h.nextSibling; const moved = [];
          while(n && n !== nextH){ const cur = n; n = n.nextSibling; moved.push(cur); }
          if(!moved.length) return; moved.forEach(x=>wrapper.appendChild(x));
          h.parentNode.insertBefore(wrapper, nextH);
          const key = 'cls:' + docId + '#' + h.id; const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'section-toggle'; btn.textContent = '‚àí'; btn.title = 'Comprimi sezione';
          const apply = (c)=>{ wrapper.style.display = c ? 'none' : ''; btn.textContent = c ? '+' : '‚àí'; btn.title = c ? 'Espandi sezione' : 'Comprimi sezione'; };
          let collapsed = false; try { collapsed = localStorage.getItem(key) === '1'; } catch(e){}
          apply(collapsed);
          btn.addEventListener('click', ()=>{ collapsed = !collapsed; apply(collapsed); try { localStorage.setItem(key, collapsed ? '1' : '0'); } catch(e){} });
          h.appendChild(btn);
        });
      }
      function setupProgress(container){
        const bar = document.getElementById('read-progress'); if(!bar) return;
        function onScroll(){
          const rect = container.getBoundingClientRect(); const vh = window.innerHeight || document.documentElement.clientHeight; const total = rect.height;
          const top = Math.max(0, -rect.top); const seen = Math.min(total, top + vh);
          const pct = total > 0 ? Math.max(0, Math.min(1, seen / total)) : 0; bar.style.width = (pct*100).toFixed(1) + '%';
        }
        onScroll(); document.addEventListener('scroll', onScroll, { passive: true }); window.addEventListener('resize', onScroll);
      }
      document.addEventListener('DOMContentLoaded', function(){ const md = document.getElementById('cls-md'); if(!md) return; ensureIds(md); addAnchors(md); makeCollapsible(md); setupProgress(md); });
    })();
  </script>
{% endblock %}

{% block content %}
  {% macro render_value(v) %}
    {% if v is string or v is number or v in [true,false] %}
      <div class="font-medium break-words">{{ v }}</div>
    {% elif v is mapping %}
      {% if v.get('scegli') is not none and (v.get('opzioni') is sequence) and (v.get('opzioni') is not string) %}
        {% set choose = (v.get('scegli') | int) %}
        {% if choose > 0 %}<div class="text-xs text-neutral-600">Scegli {{ choose }}</div>{% endif %}
        <div class="flex flex-wrap gap-1">{% for s in v.get('opzioni') %}<span class="tag">{{ s }}</span>{% endfor %}</div>
      {% elif v.get('lista_incantesimi') is mapping or v.get('trucchetti') %}
        {% set per = v.get('lista_incantesimi') or {} %}
        {% set keys = per.keys() | list %}
        {% set lvls = (keys | map('int') | list | sort) %}
        <div class="space-y-1">
          {% if v.get('trucchetti') %}
            <details>
              <summary class="cursor-pointer py-0.5 px-2 hover:bg-neutral-50">Trucchetti</summary>
              <div class="flex flex-wrap gap-1 p-2">{% for s in v.get('trucchetti') %}<span class="tag">{{ s }}</span>{% endfor %}</div>
            </details>
          {% endif %}
          {% for lvl in lvls %}
            {% set vals = per.get(lvl|string) %}
            <details>
              <summary class="cursor-pointer py-0.5 px-2 hover:bg-neutral-50"><span class="mono text-neutral-600">Lv {{ lvl }}</span></summary>
              <div class="flex flex-wrap gap-1 p-2">{% for s in vals %}<span class="tag">{{ s }}</span>{% endfor %}</div>
            </details>
          {% endfor %}
        </div>
      {% else %}
        <details>
          <summary class="cursor-pointer text-neutral-600">Oggetto</summary>
          <pre class="mono whitespace-pre-wrap bg-neutral-50 border p-2 mt-1">{{ v | tojson(indent=2) }}</pre>
        </details>
      {% endif %}
    {% elif v is sequence and (v is not string) %}
      {% set n = v|length %}
      {% if n > 0 and (v[0] is string or v[0] is number) %}
        <div class="flex flex-wrap gap-1">
          {% for s in v %}<span class="tag">{{ s }}</span>{% endfor %}
        </div>
      {% elif n > 0 and (v[0] is mapping) %}
        {% if v[0].get('etichetta') and (v[0].get('oggetti') is sequence) and (v[0].get('oggetti') is not string) %}
          <div class="space-y-1">
            {% for opt in v %}
              <div>
                <div class="text-xs text-neutral-500">{{ opt.get('etichetta') }}</div>
                <div class="flex flex-wrap gap-1">{% for s in opt.get('oggetti') %}<span class="tag">{{ s }}</span>{% endfor %}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          {% set looks_feats = (v[0].get('nome') or v[0].get('name')) and (v[0].get('descrizione') or v[0].get('description')) %}
          {% if looks_feats %}
            <div class="space-y-1">
              {% for it in v %}
                {% set nm = it.get('nome') or it.get('name') %}
                {% set lvl = it.get('livello') or it.get('level') %}
                {% set desc = it.get('descrizione') or it.get('description') %}
                <details>
                  <summary class="cursor-pointer py-0.5 px-2 hover:bg-neutral-50">
                    {% if lvl is not none %}<span class="mono text-neutral-600">Lv {{ lvl }}</span> ‚Äî {% endif %}{{ nm }}
                  </summary>
                  {% if desc %}
                    <div class="p-2 text-sm" data-markdown>{{ desc }}</div>
                  {% endif %}
                </details>
              {% endfor %}
            </div>
          {% else %}
            <div class="border divide-y">
              {% for it in v[:50] %}
                {% set title = it.get('nome') or it.get('name') or it.get('titolo') or it.get('title') or it.get('slug') or ('Elemento ' ~ loop.index) %}
                <details>
                  <summary class="cursor-pointer py-1 px-2 hover:bg-neutral-50">
                    <span class="font-medium">{{ title }}</span>
                    {% if it.get('livello') or it.get('level') %}
                      <span class="ml-2 text-xs text-neutral-500">Lv {{ it.get('livello') or it.get('level') }}</span>
                    {% endif %}
                  </summary>
                  <div class="p-2 text-sm">
                    <pre class="mono whitespace-pre-wrap bg-neutral-50 border p-2">{{ it | tojson(indent=2) }}</pre>
                  </div>
                </details>
              {% endfor %}
            </div>
          {% endif %}
        {% endif %}
        {% if n > 50 %}
          <div class="text-xs text-neutral-500 mt-1">Mostrati 50 di {{ n }} elementi.</div>
        {% endif %}
      {% else %}
        <details>
          <summary class="cursor-pointer text-neutral-600">Lista complessa ({{ v|length }} elementi)</summary>
          <pre class="mono whitespace-pre-wrap bg-neutral-50 border p-2 mt-1">{{ v | tojson(indent=2) }}</pre>
        </details>
      {% endif %}
    {% elif v is mapping %}
      {% set keys = v.keys() | list %}
      {# Riconosci pattern "lista per livello" tipo {'trucchetti': [...], '1': [...], '2': [...]} #}
      {% set looks_levels = true %}
      {% for kk in keys %}
        {% if not ((kk|string).isdigit() or (kk|string)|lower == 'trucchetti') %}
          {% set looks_levels = false %}
        {% endif %}
      {% endfor %}
      {% if looks_levels %}
        <div class="space-y-1">
          {% if v.get('trucchetti') %}
            <div>
              <div class="text-xs text-neutral-500">Trucchetti</div>
              <div class="flex flex-wrap gap-1">{% for s in v.get('trucchetti') %}<span class="tag">{{ s }}</span>{% endfor %}</div>
            </div>
          {% endif %}
          {% set lvls = (keys | reject('equalto','trucchetti') | map('int') | list | sort) %}
          {% for lvl in lvls %}
            {% set sval = lvl|string %}
            {% set vals = v.get(sval) %}
            <div>
              <div class="text-xs text-neutral-500">Livello {{ lvl }}</div>
              {% if vals is sequence and (vals is not string) %}
                {% if vals and (vals[0] is string or vals[0] is number) %}
                  <div class="flex flex-wrap gap-1">{% for s in vals %}<span class="tag">{{ s }}</span>{% endfor %}</div>
                {% else %}
                  <pre class="mono whitespace-pre-wrap bg-neutral-50 border p-2 mt-1">{{ vals | tojson(indent=2) }}</pre>
                {% endif %}
              {% else %}
                <div class="font-medium break-words">{{ vals }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <details>
          <summary class="cursor-pointer text-neutral-600">Oggetto</summary>
          <pre class="mono whitespace-pre-wrap bg-neutral-50 border p-2 mt-1">{{ v | tojson(indent=2) }}</pre>
        </details>
      {% endif %}
    {% else %}
      <div class="font-medium break-words">{{ v }}</div>
    {% endif %}
  {% endmacro %}
  {% set c = doc_obj %}
  {% set ns = namespace(body=None, body_key=None) %}
  {% if c.get('description') %}
    {% set ns.body = c.get('description') %}
    {% set ns.body_key = 'description' %}
  {% elif c.get('description_md') %}
    {% set ns.body = c.get('description_md') %}
    {% set ns.body_key = 'description_md' %}
  {% elif c.get('content') %}
    {% set ns.body = c.get('content') %}
    {% set ns.body_key = 'content' %}
  {% else %}
    {% for k, v in c.items() %}
      {% if ns.body is none and (k.endswith('_md')) and v %}
        {% set ns.body = v %}
        {% set ns.body_key = k %}
      {% endif %}
    {% endfor %}
  {% endif %}

  <article class="bg-white border p-4" data-md-section>
      <header class="mb-4">
        <h1 class="text-2xl font-semibold mb-2">{{ doc_title }}</h1>
        <div class="text-xs text-neutral-600 flex items-center flex-wrap gap-2">
          <span class="mono bg-neutral-100 border px-2 py-0.5" title="{{ doc_id }}">{{ doc_id }}</span>
        </div>
      </header>
      <div id="read-progress" aria-hidden="true" style="position:fixed;left:0;top:calc(var(--site-header-h));height:3px;background:linear-gradient(90deg,#4f46e5,#22c55e);width:0;z-index:30"></div>
      <section class="space-y-2">
        <h2 class="text-sm font-semibold text-neutral-700">Metadati</h2>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2 text-sm">
          {% for item in c|dictsort %}
            {% set k = item[0] %}
            {% set v = item[1] %}
            {# Escludi id/slug/tables e campi testuali principali #}
            {% if not (
              k in ['_id','id','slug','table','tables','tabella_livelli']
              or k == 'description'
              or (k|length>0 and k[0]=='_')
              or k.endswith('_md')
              or k == ns.body_key
            ) %}
              {% if v is not none and (not (v is string) or (v|trim) != '') %}
              <div class="min-w-0">
                <div class="text-neutral-500">{{ k }}</div>
                {% if k == 'sottoclassi' and v is sequence and (v is not string) %}
                  <div class="space-y-2">
                    {% for sc in v %}
                      {% set nome = sc.get('nome') or sc.get('name') or 'Sottoclasse' %}
                      {% set feats = sc.get('privilegi_sottoclasse') or [] %}
                      {% set incs = sc.get('incantesimi_aggiuntivi') or [] %}
                      <details>
                        <summary class="cursor-pointer py-1 px-2 hover:bg-neutral-50">
                          <span class="font-medium">{{ nome }}</span>
                          {% if feats %}<span class="ml-2 text-xs text-neutral-500">{{ feats|length }} privilegi</span>{% endif %}
                          {% if incs %}<span class="ml-2 text-xs text-neutral-500">incantesimi aggiuntivi</span>{% endif %}
                        </summary>
                        <div class="p-2 space-y-2 text-sm">
                          {% if feats %}
                            <div>
                              <div class="text-xs text-neutral-500 mb-1">Privilegi</div>
                              <div class="space-y-1">
                                {% for f in feats %}
                                  <details>
                                    <summary class="cursor-pointer py-0.5 px-2 hover:bg-neutral-50">
                                      <span class="mono text-neutral-600">Lv {{ f.get('livello') }}</span> ‚Äî {{ f.get('nome') }}
                                    </summary>
                                    {% if f.get('descrizione') %}
                                      <div class="p-2 text-sm" data-markdown>{{ f.get('descrizione') }}</div>
                                    {% endif %}
                                  </details>
                                {% endfor %}
                              </div>
                            </div>
                          {% endif %}
                          {% if incs %}
                            <div>
                              <div class="text-xs text-neutral-500 mb-1">Incantesimi aggiuntivi</div>
                              {% for tab in incs %}
                                <div class="mb-1">
                                  {% if tab.get('nome') %}<div class="font-medium">{{ tab.get('nome') }}</div>{% endif %}
                                  {% set per = tab.get('per_livello') or {} %}
                                  {% if per.get('trucchetti') %}
                                    <div class="text-xs text-neutral-500">Trucchetti</div>
                                    <div class="flex flex-wrap gap-1 mb-1">{% for s in per.get('trucchetti') %}<span class="tag">{{ s }}</span>{% endfor %}</div>
                                  {% endif %}
                                  {% set keys = per.keys() | list %}
                                  {% set lvls = (keys | reject('equalto','trucchetti') | map('int') | list | sort) %}
                                  {% for lvl in lvls %}
                                    {% set vals = per.get(lvl|string) %}
                                    <div class="text-xs text-neutral-500">Livello {{ lvl }}</div>
                                    <div class="flex flex-wrap gap-1 mb-1">{% for s in vals %}<span class="tag">{{ s }}</span>{% endfor %}</div>
                                  {% endfor %}
                                </div>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </details>
                    {% endfor %}
                  </div>
                {% else %}
                  {{ render_value(v) }}
                {% endif %}
              </div>
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </section>

      <hr class="my-4" />
      

      {% if body_html %}
        <div class="flex justify-end mb-2">
          <button type="button" class="btn btn-ghost !px-2 !py-1 text-xs" onclick="copyMarkdown(this)" title="Copia Markdown">Copia Markdown</button>
        </div>
        <div id="cls-md" data-markdown data-ssr="true" data-raw="{{ body_raw | e }}" class="prose max-w-none">{{ body_html | safe }}</div>
      {% else %}
        <div class="text-sm text-neutral-600">Nessun contenuto testuale disponibile.</div>
      {% endif %}
  </article>
{% endblock %}
