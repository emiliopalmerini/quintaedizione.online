<!-- app/templates/show_class.html (updated for Italian fields) -->
{% extends "base.html" %}
{% block title %}{{ doc_title or doc_id }} • {{ collection }}{% endblock %}

{% block header_actions %}
  <nav class="flex items-center gap-2" aria-label="Azioni documento">
    <a href="/list/{{ collection }}{% if qs %}?{{ qs }}{% endif %}" class="btn btn-ghost">← Lista</a>
    <form method="get" action="/show/{{ collection }}/{{ prev_id }}" class="inline" aria-label="Documento precedente">
      {% if request %}
        {% for key, val in request.query_params.items() %}
          <input type="hidden" name="{{ key }}" value="{{ val }}">
        {% endfor %}
      {% endif %}
      <button type="submit" class="btn btn-ghost" {% if not prev_id %}disabled aria-disabled="true" tabindex="-1"{% endif %}>‹ Precedente</button>
    </form>
    <form method="get" action="/show/{{ collection }}/{{ next_id }}" class="inline" aria-label="Documento successivo">
      {% if request %}
        {% for key, val in request.query_params.items() %}
          <input type="hidden" name="{{ key }}" value="{{ val }}">
        {% endfor %}
      {% endif %}
      <button type="submit" class="btn btn-ghost" {% if not next_id %}disabled aria-disabled="true" tabindex="-1"{% endif %}>Successivo ›</button>
    </form>
    <a href="/edit_raw/{{ collection }}/{{ doc_id }}{% if qs %}?{{ qs }}{% endif %}"
       class="btn" title="Modifica come JSON">Modifica (JSON)</a>
  </nav>
{% endblock %}

{% block content %}
  {% set c = doc_obj %}
  <div class="grid grid-cols-12 gap-4">
    <aside class="col-span-12 md:col-span-3 lg:col-span-2 h-[calc(100vh-7rem)] md:sticky md:top-16 overflow-auto border bg-white rounded-md p-3" aria-label="Indice della classe">
      <div class="flex items-center justify-between mb-2">
        <div class="text-[11px] uppercase tracking-wide text-neutral-500 px-1">Sezioni</div>
        <button id="toc-toggle" class="btn btn-ghost md:hidden !py-1 !px-2 text-xs" aria-controls="cls-toc" aria-expanded="false">Indice ▾</button>
      </div>
      <nav id="cls-toc" class="text-sm space-y-1 hidden md:block" aria-label="Sommario"></nav>
    </aside>

    <article class="col-span-12 md:col-span-9 lg:col-span-10 bg-white border rounded-md p-4" data-md-section>
      <div id="cls-md" data-markdown data-md-src-id="cls-md-data" class="prose max-w-none"></div>
      <script id="cls-md-data" type="text/markdown">{{ (c.content or '') | e }}</script>
    </article>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function(){
      function slugify(text){
        return (text || '').toString().toLowerCase()
          .replace(/\s+/g,'-')
          .replace(/[^\w\-àèéìòùçñ]/g,'')
          .replace(/\-+/g,'-')
          .replace(/^\-+|\-+$/g,'');
      }
      function buildToc(){
        var container = document.getElementById('cls-md');
        var toc = document.getElementById('cls-toc');
        if(!container || !toc) return;
        // Clear
        toc.innerHTML = '';
        // Include H3 and H4 sections in the TOC
        var hs = container.querySelectorAll('h3, h4');
        if(!hs.length){ toc.innerHTML = '<div class="text-xs text-neutral-500">Nessuna sezione</div>'; return; }
        hs.forEach(function(h){
          if(!h.id){ h.id = slugify(h.textContent || 'sezione'); }
          var a = document.createElement('a');
          a.href = '#' + h.id;
          a.textContent = h.textContent || '';
          a.className = 'block px-2 py-1 rounded hover:bg-neutral-100 truncate';
          a.setAttribute('data-target-id', h.id);
          var wrap = document.createElement('div');
          // Indentation for nested levels
          if(h.tagName === 'H4'){ wrap.style.marginLeft = '1rem'; }
          wrap.appendChild(a);
          toc.appendChild(wrap);
        });
        setupScrollSpy();
      }
      function setupScrollSpy(){
        var container = document.getElementById('cls-md');
        var toc = document.getElementById('cls-toc');
        if(!container || !toc) return;
        var links = toc.querySelectorAll('a[data-target-id]');
        var targets = [];
        links.forEach(function(a){
          var id = a.getAttribute('data-target-id');
          var el = document.getElementById(id);
          if(el){ targets.push({ el: el, link: a }); }
        });
        function setActive(id){
          links.forEach(function(a){
            var active = a.getAttribute('data-target-id') === id;
            a.classList.toggle('bg-indigo-50', active);
            a.classList.toggle('text-indigo-700', active);
            a.setAttribute('aria-current', active ? 'true' : 'false');
          });
        }
        if('IntersectionObserver' in window){
          var currentId = null;
          var obs = new IntersectionObserver(function(entries){
            entries.forEach(function(ent){
              if(ent.isIntersecting){ currentId = ent.target.id; }
            });
            if(currentId){ setActive(currentId); }
          }, { root: null, rootMargin: '-80px 0px -70% 0px', threshold: 0 });
          targets.forEach(function(t){ obs.observe(t.el); });
        } else {
          window.addEventListener('scroll', function(){
            var top = window.scrollY || document.documentElement.scrollTop || 0;
            var closest = null, closestDist = 1e9;
            targets.forEach(function(t){
              var rect = t.el.getBoundingClientRect();
              var dist = Math.abs(rect.top);
              if(dist < closestDist){ closestDist = dist; closest = t; }
            });
            if(closest){ setActive(closest.el.id); }
          });
        }
      }
      document.addEventListener('markdown:rendered', buildToc);
      document.body.addEventListener('htmx:afterSwap', function(){ setTimeout(buildToc, 0); });

      // Toggle TOC on mobile
      document.addEventListener('DOMContentLoaded', function(){
        var btn = document.getElementById('toc-toggle');
        var toc = document.getElementById('cls-toc');
        if(!btn || !toc) return;
        btn.addEventListener('click', function(){
          var hidden = toc.classList.toggle('hidden');
          btn.setAttribute('aria-expanded', (!hidden).toString());
          btn.textContent = hidden ? 'Indice ▾' : 'Indice ▴';
        });
      });
    })();
  </script>
{% endblock %}

{# scripts block for markdown already handled in base.html; TOC script above #}
