<!-- app/templates/_doc_form.html -->
{% extends "base.html" %}
{% block title %}Modifica • {{ collection }}{% endblock %}

{% block header_actions %}
  <a href="/list/{{ collection }}{% if qs %}?{{ qs }}{% endif %}" class="btn" title="Torna alla lista">← Lista</a>

  <form method="get" action="/edit/{{ collection }}/{{ prev_id }}" class="inline" aria-label="Documento precedente">
    {% if request %}
      {% for key, val in request.query_params.items() %}
        <input type="hidden" name="{{ key }}" value="{{ val }}">
      {% endfor %}
    {% endif %}
    <button type="submit" class="btn btn-ghost"
            {% if not prev_id %}disabled aria-disabled="true" tabindex="-1"{% endif %}>‹ Precedente</button>
  </form>

  <form method="get" action="/edit/{{ collection }}/{{ next_id }}" class="inline" aria-label="Documento successivo">
    {% if request %}
      {% for key, val in request.query_params.items() %}
        <input type="hidden" name="{{ key }}" value="{{ val }}">
      {% endfor %}
    {% endif %}
    <button type="submit" class="btn btn-ghost"
            {% if not next_id %}disabled aria-disabled="true" tabindex="-1"{% endif %}>Successivo ›</button>
  </form>

  <a href="/show/{{ collection }}/{{ doc_id }}{% if qs %}?{{ qs }}{% endif %}" class="btn btn-ghost" title="Apri anteprima">Mostra</a>
  <div class="inline-flex rounded-md border overflow-hidden" role="group" aria-label="Modalità editor">
    <a href="/edit/{{ collection }}/{{ doc_id }}{% if qs %}?{{ qs }}{% endif %}"
       class="btn !rounded-none {% if true %}!bg-indigo-600 !text-white !border-indigo-600{% endif %}"
       aria-current="page" title="Modifica per campi">Campi</a>
    <a href="/edit_raw/{{ collection }}/{{ doc_id }}{% if qs %}?{{ qs }}{% endif %}"
       class="btn !rounded-none" title="Modifica come JSON">JSON</a>
  </div>
  <button form="doc-form" type="submit" class="btn btn-primary !px-4 !py-2 text-[14px] shadow-sm" title="Salva (⌘/Ctrl+S)">
    Salva (⌘/Ctrl+S)
  </button>
  <button type="button" class="btn btn-ghost" onclick="openShortcuts()" title="Mostra scorciatoie">Scorciatoie</button>
{% endblock %}

{% block content %}
  <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-white border rounded px-3 py-1">Salta al contenuto</a>

  <div class="grid grid-cols-12 gap-4 h-full">
    <!-- Sidebar indice -->
    <aside class="col-span-12 md:col-span-4 xl:col-span-3 2xl:col-span-2 h-[calc(100vh-7rem)] md:sticky md:top-16 overflow-auto border bg-white rounded-md p-3"
           aria-label="Indice sezioni">
      <div class="text-[11px] uppercase tracking-wide text-neutral-500 px-1 mb-2">Sezioni</div>
      <input id="filter-fields" type="text" placeholder="Filtra campi…" class="field mb-2" aria-label="Filtra campi" />
      <ul class="space-y-1" id="toc">
        {% set seen = [] %}
        {% for path, _ in fields %}
          {% set top = path.split('.')[0] %}
          {% if top not in seen %}
            {% set _ = seen.append(top) %}
            <li>
              <a href="#sec-{{ top|replace(' ','-') }}"
                 class="block px-2 py-1.5 rounded text-sm hover:bg-neutral-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                 data-toc-link>{{ top }}</a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </aside>

    <!-- Editor -->
    <main id="main" class="col-span-12 md:col-span-8 xl:col-span-9 2xl:col-span-10 overflow-auto">
      <form id="doc-form"
            hx-put="/edit/{{ collection }}/{{ doc_id }}"
            hx-target="#global-toast"
            hx-swap="innerHTML"
            hx-indicator="#saving"
            class="space-y-4"
            aria-describedby="saving">
        <div id="saving" class="hidden htmx-indicator text-sm text-neutral-600" role="status" aria-live="polite">Salvataggio in corso…</div>

        <!-- Meta -->
        <section class="bg-white border rounded-md p-3 flex items-center justify-between gap-3 flex-wrap" aria-label="Metadati documento">
          <div class="min-w-0">
            <div class="text-[11px] text-neutral-500">ID documento</div>
            <div class="mono bg-neutral-100 border rounded px-2 py-1 truncate" title="{{ doc_id }}">{{ doc_id }}</div>
          </div>
          <div class="flex items-center gap-2 shrink-0">
            <a href="/list/{{ collection }}" class="btn btn-ghost !px-3 !py-2">Annulla</a>
            <button type="reset" class="btn btn-ghost !px-3 !py-2">Reimposta</button>
            <button type="submit" class="btn btn-primary !px-4 !py-2 shadow">Salva</button>
          </div>
          <div class="w-full"></div>
          <div class="flex items-center gap-3 text-sm">
            <label class="inline-flex items-center gap-2"><input id="toggle-translatable" type="checkbox"> <span>Solo traducibili</span></label>
            <label class="inline-flex items-center gap-2"><input id="toggle-modified" type="checkbox"> <span>Solo modificati</span></label>
          </div>
        </section>

        {% set current = None %}
        {% for path, value in fields %}
          {% set top = path.split('.')[0] %}
          {% if current != top %}
            {% if not loop.first %}
                </div>
              </fieldset>
            {% endif %}
            <fieldset id="sec-{{ top|replace(' ','-') }}" class="border bg-white rounded-md" aria-labelledby="h-{{ loop.index0 }}-{{ top|replace(' ','-') }}">
              <legend id="h-{{ loop.index0 }}-{{ top|replace(' ','-') }}"
                      class="px-3 py-2 border-b sticky top-0 bg-white text-sm font-semibold">
                <span>{{ top }}</span>
              </legend>
              <div class="p-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            {% set current = top %}
          {% endif %}

          {% set last = path.split('.')[-1] %}
          {% set is_index = last.isdigit() %}
          {% set label = is_index and (path.rsplit('.', 1)[0] ~ '[' ~ last ~ ']') or path %}
          {% set v = value if value is not none else '' %}
          {% set v_str = v|string %}
          {% set is_md = last.endswith('_md') or ('_md' in path) %}
          {% set is_long = is_md or ('description' in path) or ('text' in path) or (v_str|length > 160) %}
          {% set is_bool = v_str|lower in ['true','false'] %}
          {% set is_number = (v_str|replace('.','',1)).isdigit() %}

          <!-- Campo -->
          {% set is_translatable = is_long or is_md or ('name' in last) or ('title' in last) or ('text' in path) or ('desc' in path) or ('description' in path) or ('higher_level' in path) %}
          <div class="space-y-1" data-field data-path="{{ path }}" data-translatable="{{ 'true' if is_translatable else 'false' }}">
            {% if not is_long %}
              <label for="f.{{ path }}" class="text-[12px] font-medium text-neutral-800">{{ label }}</label>
            {% endif %}

            {% if is_bool %}
              <input type="hidden" name="f.{{ path }}" value="false">
              <label class="inline-flex items-center gap-2 text-sm">
                <input id="f.{{ path }}" type="checkbox" name="f.{{ path }}" value="true"
                       {% if v_str|lower == 'true' %}checked{% endif %}
                       class="h-5 w-5 rounded border-neutral-300 text-indigo-600 focus:ring-indigo-600">
                <span>True</span>
              </label>

            {% elif is_long %}
              <div class="relative">
                <div class="flex items-center justify-end mb-1">
                  <div class="flex gap-2">
                    <button type="button" class="btn btn-ghost !px-2 !py-1 text-xs"
                            onclick="copyFrom(this)" title="Copia contenuto">Copia</button>
                    <button type="button" class="btn btn-ghost !px-2 !py-1 text-xs"
                            onclick="replaceFromClipboard(this)" title="Sostituisci col contenuto degli appunti">Sostituisci</button>
                    <button type="button" class="btn btn-ghost !px-2 !py-1 text-xs"
                            onclick="selectAll(this)" title="Seleziona tutto">Seleziona</button>
                    <button type="button" class="btn btn-ghost !px-2 !py-1 text-xs"
                            onclick="toggleFull(this)" aria-expanded="false" title="Espandi area">Espandi</button>
                    <button type="submit" name="save_field" value="{{ path }}"
                            class="btn btn-primary !px-3 !py-1 text-xs shadow-sm" title="Salva solo questo campo">Salva campo</button>
                  </div>
                </div>
                <textarea id="f.{{ path }}" name="f.{{ path }}"
                          class="field mono resize-y {{ 'min-h-[420px]' if is_md else 'min-h-[260px]' }} leading-6 auto-grow w-full"
                          data-initial="{{ v_str|e }}"
                          rows="10"
                          aria-label="{{ label }}">{{ v_str }}</textarea>
                <div class="mt-1 text-[11px] text-neutral-500"><span data-count>0</span> caratteri</div>
              </div>

            {% else %}
              <div class="flex items-center gap-2 overflow-x-auto">
                <input id="f.{{ path }}"
                       {% if is_number %}type="number" step="any" inputmode="decimal"{% else %}type="text" inputmode="text"{% endif %}
                       name="f.{{ path }}" value="{{ v_str }}"
                       class="field mono w-full"
                       data-initial="{{ v_str|e }}"
                       aria-describedby="hint-{{ loop.index }}">
                <button type="button"
                        class="btn btn-ghost !px-2 !py-1 text-xs"
                        hx-put="/edit/{{ collection }}/{{ doc_id }}"
                        hx-include="#f\\.{{ path }}"
                        hx-target="#field-toast-{{ loop.index }}"
                        hx-swap="innerHTML">Salva</button>
              </div>
              <p id="hint-{{ loop.index }}" class="sr-only">Premi Salva per aggiornare solo questo campo</p>
              <div id="field-toast-{{ loop.index }}" aria-live="polite"></div>
            {% endif %}
          </div>

          {% if loop.last %}
              </div>
            </fieldset>
          {% endif %}
        {% endfor %}

        <!-- Barra azioni flottante -->
        <div class="sticky bottom-3 z-10">
          <div class="max-w-xl ml-auto">
            <div class="bg-white border rounded-md shadow px-3 py-2 flex items-center justify-between">
              <span class="text-sm text-neutral-700">Rivedi e salva le modifiche</span>
              <div class="flex items-center gap-2">
                <a href="/list/{{ collection }}" class="btn btn-ghost !px-3 !py-2">Annulla</a>
                <button type="button" class="btn btn-ghost" onclick="saveAndStay()">Salva</button>
                <button type="button" class="btn btn-ghost" onclick="saveAndGo('prev')" {% if not prev_id %}disabled{% endif %}>Salva e ← Prec.</button>
                <button type="button" class="btn btn-primary" onclick="saveAndGo('next')" {% if not next_id %}disabled{% endif %}>Salva e Succ. →</button>
              </div>
            </div>
          </div>
        </div>

        <div id="global-toast" class="mt-3" aria-live="polite"></div>
      </form>
    </main>
  </div>
  <!-- Modal scorciatoie -->
  <div id="shortcut-modal" class="hidden fixed inset-0 z-50" aria-modal="true" role="dialog" aria-labelledby="shortcuts-title">
    <div class="absolute inset-0 bg-black/30" onclick="closeShortcuts()"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-white border rounded-md shadow-xl w-[min(90vw,640px)]">
      <div class="px-4 py-2 border-b flex justify-between items-center">
        <h2 id="shortcuts-title" class="text-sm font-semibold">Scorciatoie da tastiera</h2>
        <button class="btn btn-ghost !px-2 !py-1 text-xs" onclick="closeShortcuts()">Chiudi (Esc)</button>
      </div>
      <div class="p-4 text-sm space-y-2">
        <div><span class="tag">Ctrl/Cmd + S</span> Salva documento</div>
        <div><span class="tag">Ctrl + Alt + D</span> Vai al prossimo campo “description”</div>
        <div><span class="tag">Ctrl + Alt + Shift + D</span> Vai al campo “description” precedente</div>
        <div class="text-xs text-neutral-600 pt-2">Suggerimento: usa i pulsanti “Salva e Succ.” / “Salva e ← Prec.” per la navigazione tra documenti.</div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    // TOC attivo con IntersectionObserver
    function initTOC(){
      const links = Array.from(document.querySelectorAll('[data-toc-link]'));
      const map = new Map(links.map(a=>[a.getAttribute('href').slice(1), a]));
      const obs = new IntersectionObserver((entries)=>{
        entries.forEach(en=>{
          const a = map.get(en.target.id);
          if(!a) return;
          if(en.isIntersecting){
            links.forEach(l=>l.classList.remove('bg-neutral-100'));
            a.classList.add('bg-neutral-100');
          }
        });
      },{ rootMargin: '-40% 0px -55% 0px', threshold: 0 });
      map.forEach((_, id)=>{
        const sec = document.getElementById(id);
        if(sec) obs.observe(sec);
      });
    }
    // Seleziona tutto nel textarea
    function selectAll(btn){ const ta = btn.closest('.relative')?.querySelector('textarea'); if(ta){ ta.focus(); ta.select(); }}
    // Marcatura modifiche e conteggio caratteri
    function initEditingAids(){
      document.querySelectorAll('[data-field]').forEach(box=>{
        const input = box.querySelector('textarea, input[type="text"], input[type="number"]');
        if(!input) return;
        const initial = input.getAttribute('data-initial') ?? '';
        const countEl = box.querySelector('[data-count]');
        const update = ()=>{
          const cur = (input.value ?? '').toString();
          if(countEl) countEl.textContent = cur.length.toString();
          if(cur !== initial){ box.classList.add('ring-1','ring-indigo-200','modified'); }
          else { box.classList.remove('ring-1','ring-indigo-200','modified'); }
        };
        input.addEventListener('input', update);
        update();
      });
    }
    // Filtri: traducibili, modificati, ricerca
    function initFilters(){
      const q = document.getElementById('filter-fields');
      const onlyTrans = document.getElementById('toggle-translatable');
      const onlyMod = document.getElementById('toggle-modified');
      const apply = ()=>{
        const t = (q.value||'').toLowerCase();
        document.querySelectorAll('[data-field]').forEach(box=>{
          const path = (box.getAttribute('data-path')||'').toLowerCase();
          const matchText = !t || path.includes(t);
          const matchTrans = !onlyTrans.checked || box.getAttribute('data-translatable')==='true';
          const matchMod = !onlyMod.checked || box.classList.contains('modified');
          box.style.display = (matchText && matchTrans && matchMod) ? '' : 'none';
        });
      };
      [q, onlyTrans, onlyMod].forEach(el=> el && el.addEventListener('input', apply));
      [onlyTrans, onlyMod].forEach(el=> el && el.addEventListener('change', apply));
      apply();
    }
    // Salva e vai
    function saveAndGo(dir){
      window.__redirectAfterSave = dir; saveForm();
    }
    function saveAndStay(){ window.__redirectAfterSave = null; saveForm(); }
    function saveForm(){
      const form = document.getElementById('doc-form'); if(!form) return;
      form.requestSubmit ? form.requestSubmit() : form.submit();
    }
    document.body.addEventListener('htmx:afterRequest', (e)=>{
      const tgt = e.detail && e.detail.target; if(!tgt) return;
      if(tgt.id === 'global-toast' && e.detail.xhr && e.detail.xhr.status>=200 && e.detail.xhr.status<300){
        const dir = window.__redirectAfterSave; if(!dir) return;
        const qs = window.location.search || '';
        if(dir==='next' && '{{ next_id or '' }}') window.location = '/edit/{{ collection }}/{{ next_id or '' }}'+qs;
        if(dir==='prev' && '{{ prev_id or '' }}') window.location = '/edit/{{ collection }}/{{ prev_id or '' }}'+qs;
      }
    });
    // Init page behaviors
    // Scorciatoia: vai ai campi 'description' successivo/precedente
    function initDescriptionShortcut(){
      const fields = Array.from(document.querySelectorAll('[data-field]'))
        .filter(b=>{
          const p=(b.getAttribute('data-path')||'').toLowerCase();
          return p.includes('description');
        });
      if(fields.length===0) return;
      let idx = -1;
      const focusAt = (i)=>{
        const box = fields[i]; if(!box) return;
        const input = box.querySelector('textarea, input[type="text"], input[type="number"]');
        if(input){ input.focus(); if(input.select) input.select(); box.scrollIntoView({behavior:'smooth', block:'center'}); }
      };
      document.addEventListener('keydown', (e)=>{
        const keyD = e.key && e.key.toLowerCase()==='d';
        if((e.ctrlKey||e.metaKey) && e.altKey && keyD){
          e.preventDefault();
          if(e.shiftKey){ idx = (idx<=0? fields.length-1 : idx-1); }
          else { idx = (idx+1) % fields.length; }
          focusAt(idx);
        }
      });
    }
    function openShortcuts(){ const m=document.getElementById('shortcut-modal'); if(m){ m.classList.remove('hidden'); }}
    function closeShortcuts(){ const m=document.getElementById('shortcut-modal'); if(m){ m.classList.add('hidden'); }}
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeShortcuts(); }});
    window.addEventListener('load', ()=>{ initTOC(); initEditingAids(); initFilters(); initDescriptionShortcut(); });
  </script>
{% endblock %}
