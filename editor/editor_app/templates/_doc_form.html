<!-- app/templates/_doc_form.html -->
{% extends "base.html" %}
{% block title %}Modifica • {{ collection }}{% endblock %}
{% block header_actions %}
  <a href="/list/{{ collection }}" class="btn btn-ghost !px-3 !py-2">← Lista</a>
  <button form="doc-form" type="submit" class="btn btn-primary !px-5 !py-2.5 !text-[14px] shadow">
    Salva (⌘/Ctrl+S)
  </button>
{% endblock %}
{% block content %}
  <div class="grid grid-cols-12 gap-4 h-full">
    <!-- Indice compatto e fisso -->
    <nav class="col-span-3 xl:col-span-2 overflow-auto border bg-white rounded-md p-2">
      <div class="text-[11px] uppercase tracking-wide text-neutral-500 px-2 mb-2">Sezioni</div>
      <ul class="space-y-1">
        {% set seen = [] %}
        {% for path, _ in fields %}
          {% set top = path.split('.')[0] %}
          {% if top not in seen %}
            {% set _ = seen.append(top) %}
            <li>
              <a href="#sec-{{ top|replace(' ','-') }}"
                 class="block px-2 py-1.5 rounded text-sm hover:bg-neutral-100">{{ top }}</a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </nav>

    <!-- Colonna editor. Layout lineare, campi con etichetta sopra. -->
    <main class="col-span-9 xl:col-span-10 overflow-auto">
      <form id="doc-form"
            hx-put="/edit/{{ collection }}/{{ doc_id }}"
            hx-target="#global-toast"
            hx-swap="outerHTML"
            hx-indicator="#saving"
            class="space-y-4">

        <div id="saving" class="hidden htmx-indicator text-sm text-neutral-600">Salvataggio in corso…</div>

        <!-- Meta -->
        <section class="bg-white border rounded-md p-3 flex items-center justify-between">
          <div>
            <div class="text-[11px] text-neutral-500">_id</div>
            <div class="mono bg-neutral-100 border rounded px-2 py-1">{{ doc_id }}</div>
          </div>
          <div class="flex items-center gap-2">
            <a href="/list/{{ collection }}" class="btn btn-ghost !px-3 !py-2">Annulla</a>
            <button type="reset" class="btn btn-ghost !px-3 !py-2">Reimposta</button>
            <button type="submit" class="btn btn-primary !px-4 !py-2 shadow">Salva</button>
          </div>
        </section>

        {% set current = None %}
        {% for path, value in fields %}
          {% set top = path.split('.')[0] %}
          {% if current != top %}
            {% if not loop.first %}
                </div>
              </section>
            {% endif %}
            <section id="sec-{{ top|replace(' ','-') }}" class="border bg-white rounded-md">
              <header class="px-3 py-2 border-b sticky top-0 bg-white flex items-center justify-between">
                <h2 class="text-sm font-semibold">{{ top }}</h2>
                <div class="flex items-center gap-2">
                  <button type="button" class="btn btn-ghost !px-2 !py-1 text-xs" onclick="window.scrollTo({top:0,behavior:'smooth'})">Top</button>
                </div>
              </header>
              <div class="p-3 space-y-3">
            {% set current = top %}
          {% endif %}

          {% set last = path.split('.')[-1] %}
          {% set is_index = last.isdigit() %}
          {% if is_index %}
            {% set label = path.rsplit('.', 1)[0] ~ '[' ~ last ~ ']' %}
          {% else %}
            {% set label = path %}
          {% endif %}

          {% set v = value if value is not none else '' %}
          {% set v_str = v|string %}
          {% set is_long = ('description' in path) or ('text' in path) or (v_str|length > 160) %}
          {% set is_bool = v_str|lower in ['true','false'] %}
          {% set is_number = (v_str|replace('.','',1)).isdigit() %}

          <!-- Campo -->
          <div class="space-y-1">
            <label for="f.{{ path }}" class="text-[12px] font-medium text-neutral-700">{{ label }}</label>

            {% if is_bool %}
              <input type="hidden" name="f.{{ path }}" value="false">
              <label class="inline-flex items-center gap-2 text-sm">
                <input id="f.{{ path }}" type="checkbox" name="f.{{ path }}" value="true"
                       {% if v_str|lower == 'true' %}checked{% endif %}
                       class="h-5 w-5 rounded border-neutral-300 text-indigo-600 focus:ring-indigo-600">
                <span>True</span>
              </label>

{% elif is_long %}
  <div class="relative col-span-12">
    <div class="flex items-center justify-between mb-1">
      <label for="f.{{ path }}" class="text-[13px] text-neutral-700 truncate">{{ label }}</label>
      <div class="flex gap-2">
        <button type="button"
                class="btn btn-ghost !px-2 !py-1 text-xs"
                onclick="navigator.clipboard.writeText(this.closest('.relative').querySelector('textarea').value)">
          Copia
        </button>
        <button type="submit"
                name="save_field"
                value="{{ path }}"
                class="btn btn-primary !px-3 !py-1 text-xs shadow-sm">
          Salva campo
        </button>
      </div>
    </div>
    <textarea id="f.{{ path }}" name="f.{{ path }}"
              class="field mono resize-y min-h-[200px] auto-grow w-full"
              rows="10">{{ v_str }}</textarea>
  </div>

            {% else %}
              <div class="flex items-center gap-2">
                <input id="f.{{ path }}"
                       {% if is_number %}type="number"{% else %}type="text"{% endif %}
                       name="f.{{ path }}" value="{{ v_str }}"
                       class="field mono" />
                <button type="button"
                        class="btn btn-ghost !px-2 !py-1 text-xs"
                        hx-put="/edit/{{ collection }}/{{ doc_id }}"
                        hx-include="#f\\.{{ path }}"
                        hx-target="#field-toast-{{ loop.index }}"
                        hx-swap="outerHTML">Salva</button>
              </div>
              <div id="field-toast-{{ loop.index }}"></div>

            {% endif %}
          </div>

          {% if loop.last %}
              </div>
            </section>
          {% endif %}
        {% endfor %}

        <!-- Barra azioni flottante -->
        <div class="sticky bottom-3">
          <div class="max-w-xl ml-auto">
            <div class="bg-white border rounded-md shadow px-3 py-2 flex items-center justify-between">
              <span class="text-sm text-neutral-700">Rivedi e salva le modifiche</span>
              <div class="flex items-center gap-2">
                <a href="/list/{{ collection }}" class="btn btn-ghost !px-3 !py-2">Annulla</a>
                <button type="submit" class="btn btn-primary !px-5 !py-2.5 shadow">
                  Salva tutte
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="global-toast" class="mt-3 hidden"></div>
      </form>
    </main>
  </div>
{% endblock %}
{% block scripts %}
  <script>
    // Auto-grow dinamico e continuo
    function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }
    function initAutoGrow(){
      document.querySelectorAll('textarea.auto-grow').forEach(t=>{
        autoGrow(t);
        t.addEventListener('input', ()=>autoGrow(t));
      });
    }
    // Toggle full-screen del campo lungo
    function toggleFull(btn){
      const wrap = btn.closest('.relative');
      const ta = wrap.querySelector('textarea');
      if(!wrap.classList.contains('fixed')){
        wrap.classList.add('fixed','inset-4','z-50','bg-white','border','rounded','p-3');
        ta.classList.add('min-h-[70vh]');
        autoGrow(ta);
        btn.textContent='Riduci';
      }else{
        wrap.classList.remove('fixed','inset-4','z-50','bg-white','border','rounded','p-3');
        ta.classList.remove('min-h-[70vh]');
        autoGrow(ta);
        btn.textContent='Espandi';
      }
    }
    // Salva rapido con ⌘/Ctrl+S
    addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
        e.preventDefault();
        document.getElementById('doc-form').requestSubmit();
      }
    });
    // Toast globali e per-campo
    document.body.addEventListener('htmx:afterRequest', (e)=>{
      const tgt=e.detail.target;
      if(!tgt) return;
      const ok='<div class="bg-green-50 text-green-800 border border-green-200 rounded px-3 py-2 text-sm">Salvato.</div>';
      const err='<div class="bg-red-50 text-red-800 border border-red-200 rounded px-3 py-2 text-sm">Errore.</div>';
      if(tgt.id && tgt.id.startsWith('field-toast-')){
        tgt.innerHTML = e.detail.successful ? ok : err;
        setTimeout(()=>{ tgt.innerHTML=''; }, 1200);
      }
      if(tgt.id==='global-toast'){
        tgt.className="mt-3";
        tgt.innerHTML = e.detail.successful ? ok : err;
        setTimeout(()=>{ tgt.innerHTML=''; tgt.className='mt-3 hidden'; }, 1400);
      }
    });
    // Inizializza
    window.addEventListener('load', initAutoGrow);
  </script>
{% endblock %}

